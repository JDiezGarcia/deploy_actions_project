pipeline {
    agent any
    triggers {
        pollSCM('1 */3 * * *')
    }
    parameters {
        string(name: 'executor', description: 'What is your name?', defaultValue: 'System' )
        string(name: 'subject', description: 'Why are you executing the pipeline?', defaultValue: 'We detected a change in the repository')
        string(name: 'email', description: 'Put your email to recieve a notificiation with the results', defaultValue: 'fco.javier.diez.garcia@gmail.com')
    }
    stages {
        stage('Lint') {
            steps {
                script {
                    sh 'npm install'
                    env.lintResult = sh(script: 'npm run lint', returnStatus: true)
                }
            }
        }
        stage('Cypress') {
            steps {
                script {
                    sh 'apt-get install -y ibgtk2.0-0 libgtk-3-0 libgbm-dev libnotify-dev libgconf-2-4 libnss3 libxss1 libasound2 libxtst6 xauth xvfb'
                    sh 'npm install cypress --save-dev'
                    sh 'npm run build && npm run start &'
                    env.cypressResult = sh(script: 'cypress run --headed && kill $(lsof -t -i :3000)', returnStatus: true)
                    
                }
            }
        }
        stage('Results') {
            steps {
                script {
                    sh "echo 'executor: ${params.executor}'"
                    sh "echo 'subject: ${params.subject}'"
                    sh "echo 'email: ${params.email}'"
                    sh "echo 'lint: ${env.lintResult}'"
                    sh "echo 'cypress: ${env.cypressResult}'"
                }
            }
        }
    }
}
